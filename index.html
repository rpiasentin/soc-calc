<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OCV → SoC Calculator with Overlay</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    /* Container locked to the chart's native size */
    #container {
      position: relative;
      width: 949px;
      height: 810px;
      margin: 0 auto;
    }
    /* Chart and overlay canvas exactly overlap */
    #chart, #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 949px;
      height: 810px;
    }
    #controls {
      width: 949px;
      margin: 1em auto;
      padding: 0 1em;
      box-sizing: border-box;
    }
    input { width: 80px; }
    button { margin-left: 8px; }
  </style>
</head>
<body>

  <!-- 1) Chart + Canvas -->
  <div id="container">
    <img id="chart" src="chart.png" width="949" height="810" alt="OCV vs SoC Curve">
    <canvas id="overlay" width="949" height="810"></canvas>
  </div>

  <!-- 2) Controls -->
  <div id="controls">
    <h1>OCV → SoC Calculator</h1>
    <label>
      Measured Voltage (V):
      <input id="volt" type="number" step="0.001" value="2.02" disabled>
    </label>
    <button id="calc" disabled>Calculate &amp; Plot</button>
    <p>Estimated SoC: <strong><span id="out">--</span>%</strong></p>
  </div>

  <script>
    // === Your 201‑point calibration arrays ===
    const soc_base = [
      0.0,0.5,1.0,1.5,2.0,2.5,3.0,3.5,4.0,4.5,5.0,5.5,6.0,6.5,7.0,7.5,8.0,8.5,9.0,9.5,
      10.0,10.5,11.0,11.5,12.0,12.5,13.0,13.5,14.0,14.5,15.0,15.5,16.0,16.5,17.0,17.5,18.0,
      18.5,19.0,19.5,20.0,20.5,21.0,21.5,22.0,22.5,23.0,23.5,24.0,24.5,25.0,25.5,26.0,26.5,
      27.0,27.5,28.0,28.5,29.0,29.5,30.0,30.5,31.0,31.5,32.0,32.5,33.0,33.5,34.0,34.5,35.0,
      35.5,36.0,36.5,37.0,37.5,38.0,38.5,39.0,39.5,40.0,40.5,41.0,41.5,42.0,42.5,43.0,43.5,
      44.0,44.5,45.0,45.5,46.0,46.5,47.0,47.5,48.0,48.5,49.0,49.5,50.0,50.5,51.0,51.5,52.0,
      52.5,53.0,53.5,54.0,54.5,55.0,55.5,56.0,56.5,57.0,57.5,58.0,58.5,59.0,59.5,60.0,60.5,
      61.0,61.5,62.0,62.5,63.0,63.5,64.0,64.5,65.0,65.5,66.0,66.5,67.0,67.5,68.0,68.5,69.0,
      69.5,70.0,70.5,71.0,71.5,72.0,72.5,73.0,73.5,74.0,74.5,75.0,75.5,76.0,76.5,77.0,77.5,
      78.0,78.5,79.0,79.5,80.0,80.5,81.0,81.5,82.0,82.5,83.0,83.5,84.0,84.5,85.0,85.5,86.0,
      86.5,87.0,87.5,88.0,88.5,89.0,89.5,90.0,90.5,91.0,91.5,92.0,92.5,93.0,93.5,94.0,94.5,
      95.0,95.5,96.0,96.5,97.0,97.5,98.0,98.5,99.0,99.5,100.0
    ];

    const v_base = [
      1.93759905395,1.94022173205,1.94317800215,1.94614956165,1.94877023110,1.95147334625,
      1.95409715735,1.95643790615,1.95901948400,1.96161150170,1.96402357930,1.96652763290,
      1.96891399880,1.97141300460,1.97375329830,1.97624143065,1.97860120285,1.98120052725,
      1.98374528000,1.98616055490,1.98852163450,1.99083089420,1.99300472945,1.99511049140,
      1.99710147530,1.99909879815,2.00100481210,2.00295147130,2.00478524570,2.00654286700,
      2.00826923115,2.01001002120,2.01165404815,2.01333830865,2.01504392225,2.01664368385,
      2.01835744915,2.01995030790,2.02151279580,2.02301442960,2.02450863420,2.02591591590,
      2.02723710460,2.02864589670,2.03004149265,2.03139454115,2.03284211630,2.03425597040,
      2.03568384265,2.03706388420,2.03842090660,2.03996012730,2.04133883630,2.04287265580,
      2.04446677650,2.04590550220,2.04746570425,2.04906149420,2.05049367090,2.05201919400,
      2.05350248735,2.05492714000,2.05641010410,2.05791859810,2.05946273300,2.06091915550,
      2.06235844565,2.06370237470,2.06513504225,2.06656712425,2.06791969512,2.06925310285,
      2.07066568670,2.07186575045,2.07314274080,2.07434921055,2.07552887440,2.07669525525,
      2.07787464765,2.07889486750,2.07974641855,2.08055234515,2.08131533690,2.08209651035,
      2.08277380650,2.08347851325,2.08396263665,2.08442767900,2.08475170170,2.08508518025,
      2.08533159000,2.08559160200,2.08576453910,2.08577759345,2.08577685415,2.08561980895,
      2.08551320450,2.08527939535,2.08496304120,2.08456765065,2.08417263865,2.08361927190,
      2.08308995325,2.08255233700,2.08200368790,2.08150723180,2.08105925135,2.08049382935,
      2.07996172650,2.07911543670,2.07815957545,2.07708912945,2.07606880560,2.07498192675,
      2.07384679250,2.07277639930,2.07165030740,2.07046175120,2.06928398300,2.06816813910,
      2.06685642960,2.06532959480,2.06373499120,2.06206096410,2.06017256920,2.05830669490,
      2.05616865330,2.05388568235,2.05149472780,2.04889831900,2.04617940945,2.04332797090,
      2.04044432770,2.03742653200,2.03444435645,2.03129263775,2.02804758155,2.02478948615,
      2.02094928100,2.01713829125,2.01296263370,2.00877805635,2.00349579625,1.99816874520,
      1.99127228290,1.98374528000,1.97522691685,1.96496851930,1.95320167290,1.93966628415,
      1.92430532605,1.90729346675,1.88781508435,1.86579775490,1.84052826315,1.81182348490,
      1.77902758545,1.74262736825,1.70246328460,1.65858123665,1.61098113175,1.55970996160,
      1.50470370000,1.44593521780,1.38348826830,1.31741639930,1.24751571375,1.17315185700,
      1.09402419005,1.01083112900,0.92339468315,0.83151312245,0.73501044065,0.63371348410,
      0.52727269135,0.41589228620,0.29847076075,0.17345646100,0.03999999950,0.00000000000
    ];

    // Build 0.01% lookup
    const s_full = Array.from({length:10001}, (_,i)=>i*0.01);
    const v_full = s_full.map(sf => {
      let lo=0, hi=soc_base.length-1;
      while(hi-lo>1){
        const mid=(lo+hi)>>1;
        if(soc_base[mid]>sf) hi=mid; else lo=mid;
      }
      const [s0,s1]=[soc_base[lo],soc_base[hi]];
      const [v0,v1]=[v_base[lo],v_base[hi]];
      const t=(sf-s0)/(s1-s0);
      return v0 + (v1-v0)*t;
    });

    function invertSoC(v){
      if(v<=v_full[0]) return 0.00;
      if(v>=v_full[v_full.length-1]) return 100.00;
      let lo=0, hi=v_full.length-1;
      while(hi-lo>1){
        const mid=(lo+hi)>>1;
        if(v_full[mid]>v) hi=mid; else lo=mid;
      }
      const [v0,v1]=[v_full[lo],v_full[hi]];
      const [s0,s1]=[s_full[lo],s_full[hi]];
      return s0 + (v-v0)*(s1-s0)/(v1-v0);
    }

    // Pixel mapping constants
    const X0=94, X1=865, Y0=137, Y1=595, VTOP=2.17, VBOT=1.82;

    const img = document.getElementById('chart'),
          canvas = document.getElementById('overlay'),
          ctx = canvas.getContext('2d');

    img.onload = () => {
      document.getElementById('volt').disabled = false;
      document.getElementById('calc').disabled = false;
      const v0=parseFloat(document.getElementById('volt').value);
      const s0=invertSoC(v0);
      document.getElementById('out').textContent=s0.toFixed(2);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const x = X0 + (s0/100)*(X1-X0);
      const y = Y0 + (VTOP-v0)/(VTOP-VBOT)*(Y1-Y0);
      ctx.beginPath(); ctx.arc(x,y,6,0,2*Math.PI);
      ctx.fillStyle='red'; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='white'; ctx.stroke();
    };
    if(img.complete) img.onload();

    document.getElementById('calc').onclick = ()=>{
      const v=parseFloat(document.getElementById('volt').value);
      const s=invertSoC(v);
      document.getElementById('out').textContent=s.toFixed(2);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const x = X0 + (s/100)*(X1-X0);
      const y = Y0 + (VTOP-v)/(VTOP-VBOT)*(Y1-Y0);
      ctx.beginPath(); ctx.arc(x,y,6,0,2*Math.PI);
      ctx.fillStyle='red'; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='white'; ctx.stroke();
    };
  </script>
</body>
</html>
