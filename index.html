<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OCV → SoC with Overlay</title>
<style>
  body { font-family: sans-serif; max-width: 700px; margin: 40px auto; }
  #container { position: relative; display: inline-block; }
  #chart { display: block; }
  #overlay { position: absolute; left: 0; top: 0; pointer-events: none; }
  input { width: 80px; }
</style>
</head>
<body>
<h1>OCV → SoC Calculator</h1>
<div id="container">
  <img id="chart" src="chart.png" alt="OCV vs SoC Curve">
  <canvas id="overlay"></canvas>
</div>
<p>
  <label>Voltage (V): <input id="volt" type="number" step="0.001" value="2.02"></label>
  <button id="calc">Calculate & Plot</button>
</p>
<p>Estimated SoC: <strong><span id="out">--</span>%</strong></p>
<script>
const soc_base = [0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 9.5, 10.0, 10.5, 11.0, 11.5, 12.0, 12.5, 13.0, 13.5, 14.0, 14.5, 15.0, 15.5, 16.0, 16.5, 17.0, 17.5, 18.0, 18.5, 19.0, 19.5, 20.0, 20.5, 21.0, 21.5, 22.0, 22.5, 23.0, 23.5, 24.0, 24.5, 25.0, 25.5, 26.0, 26.5, 27.0, 27.5, 28.0, 28.5, 29.0, 29.5, 30.0, 30.5, 31.0, 31.5, 32.0, 32.5, 33.0, 33.5, 34.0, 34.5, 35.0, 35.5, 36.0, 36.5, 37.0, 37.5, 38.0, 38.5, 39.0, 39.5, 40.0, 40.5, 41.0, 41.5, 42.0, 42.5, 43.0, 43.5, 44.0, 44.5, 45.0, 45.5, 46.0, 46.5, 47.0, 47.5, 48.0, 48.5, 49.0, 49.5, 50.0, 50.5, 51.0, 51.5, 52.0, 52.5, 53.0, 53.5, 54.0, 54.5, 55.0, 55.5, 56.0, 56.5, 57.0, 57.5, 58.0, 58.5, 59.0, 59.5, 60.0, 60.5, 61.0, 61.5, 62.0, 62.5, 63.0, 63.5, 64.0, 64.5, 65.0, 65.5, 66.0, 66.5, 67.0, 67.5, 68.0, 68.5, 69.0, 69.5, 70.0, 70.5, 71.0, 71.5, 72.0, 72.5, 73.0, 73.5, 74.0, 74.5, 75.0, 75.5, 76.0, 76.5, 77.0, 77.5, 78.0, 78.5, 79.0, 79.5, 80.0, 80.5, 81.0, 81.5, 82.0, 82.5, 83.0, 83.5, 84.0, 84.5, 85.0, 85.5, 86.0, 86.5, 87.0, 87.5, 88.0, 88.5, 89.0, 89.5, 90.0, 90.5, 91.0, 91.5, 92.0, 92.5, 93.0, 93.5, 94.0, 94.5, 95.0, 95.5, 96.0, 96.5, 97.0, 97.5, 98.0, 98.5, 99.0, 99.5, 100.0];
const v_base   = [1.93759905395, 1.94022173205, 1.94317800215, 1.94614956165, 1.9487702311000001, 1.9513365312, 1.95395389665, 1.9561573003000001, 1.95834576735, 1.96053052685, 1.96269083815, 1.9650816069500001, 1.9670153006, 1.9686408532, 1.9704750002, 1.97227900065, 1.9738394676, 1.97533153265, 1.97682309545, 1.9783351672, 1.979417902, 1.9805334293499999, 1.98204601315, 1.98279463165, 1.984276602, 1.9851874336, 1.9860097362, 1.9875114574, 1.9882693691, 1.9893385302, 1.99034872225, 1.9914653059, 1.9920609306500001, 1.9930669269, 1.9944992210499999, 1.9952326519999999, 1.9959777705, 1.9969956881, 1.9981887033499999, 1.99911488525, 1.9999238784, 2.00107419785, 2.00215847895, 2.0029272165, 2.00374049155, 2.00466636685, 2.0055394464, 2.00739638645, 2.0083966623, 2.0091726053, 2.0099259971, 2.0109130083, 2.01163047295, 2.0128057278, 2.0135133613, 2.0145875967, 2.0153363307, 2.01616189005, 2.01685287965, 2.01759308275, 2.0185385493, 2.0196950571, 2.0203977160499997, 2.0215178998, 2.0222489203, 2.0229818133, 2.0239005689, 2.02468125335, 2.0253863196, 2.02618201065, 2.0269354623, 2.0277001136, 2.0286900844, 2.0294123829, 2.0301314425, 2.0312878796, 2.03199006395, 2.03269227455, 2.03384723815, 2.0345668616, 2.03528970995, 2.0362758976, 2.0370378875, 2.0377892745, 2.038578234, 2.0393639882, 2.0401594857, 2.04083802965, 2.04163457225, 2.0424207867, 2.0432035326499998, 2.04395535155, 2.04471849785, 2.0454908068, 2.04640823555, 2.04714132525, 2.0478731455, 2.0486156523, 2.04933071035, 2.0504056503, 2.0511145487, 2.05200208465, 2.0529923953, 2.0536983012, 2.0544023808, 2.05546345305, 2.05626405775, 2.05698322305, 2.05769264645, 2.05875520935, 2.05946797595, 2.0602146614, 2.06095858045, 2.0618034395, 2.06258394335, 2.06333012515, 2.0640755134999997, 2.0648621476, 2.06563523845, 2.0663872897499997, 2.0671543018, 2.06810885785, 2.06883445335, 2.0699985831, 2.0707008511, 2.07140345125, 2.0725488511, 2.07328604, 2.07394779095, 2.07497126445, 2.07567159485, 2.0764654225, 2.0772293703, 2.07799107705, 2.07899387185, 2.07992755075, 2.0808887928499997, 2.0819153026, 2.0826678187, 2.083447583, 2.08419847825, 2.0848956863, 2.08589907155, 2.0870758972, 2.0881034804, 2.08885585335, 2.08962859245, 2.0910812117999997, 2.0921424909, 2.0933259084499998, 2.09427972845, 2.0950722184, 2.0958210196, 2.09691083735, 2.09807371935, 2.0989061597, 2.0998016235, 2.1009896656, 2.10201685505, 2.1027788929, 2.10387067765, 2.10509086655, 2.10604611735, 2.1072405115999997, 2.1081762527, 2.10942406815, 2.1105139940499997, 2.1116058995499998, 2.11276619085, 2.11381012325, 2.1149416372, 2.1159940613, 2.1174902643999998, 2.1186266794, 2.11973703445, 2.1212653931, 2.122325674, 2.1236758459, 2.12492586285, 2.1264235321, 2.1279071821, 2.12901103275, 2.1305037558, 2.13199516425, 2.1334873623, 2.1350800723, 2.13684935205, 2.1383519076499997, 2.14013884875, 2.14184121165, 2.143697591, 2.1460844202, 2.1480609465, 2.15037818205, 2.152643395, 2.1549058573, 2.157819272, 2.16122757235, 2.16462016785, 2.16781381355, 2.17];
// build densified lookup at 0.01% resolution
const s_full = Array.from({length:10001}, (_, i) => i * 0.01);
const v_full = s_full.map(sf => {
  let lo = 0, hi = soc_base.length - 1;
  while (hi - lo > 1) {
    const mid = (lo + hi) >> 1;
    if (soc_base[mid] > sf) hi = mid;
    else lo = mid;
  }
  const s0 = soc_base[lo], s1 = soc_base[hi];
  const v0 = v_base[lo],   v1 = v_base[hi];
  const t  = (sf - s0) / (s1 - s0);
  return v0 + t * (v1 - v0);
});
function invertSoC(v_meas) {
  if (v_meas <= v_full[0]) return 0;
  if (v_meas >= v_full[v_full.length - 1]) return 100;
  let lo = 0, hi = v_full.length - 1;
  while (hi - lo > 1) {
    const mid = (lo + hi) >> 1;
    if (v_full[mid] > v_meas) hi = mid;
    else lo = mid;
  }
  const v0 = v_full[lo], v1 = v_full[hi];
  const s0 = s_full[lo], s1 = s_full[hi];
  return s0 + (v_meas - v0) / (v1 - v0) * (s1 - s0);
}
// plot overlay point
const X0 = 94, X1 = 865, Y0 = 137, Y1 = 595, VTOP=2.17, VBOT=1.82;
function plotPoint(soc, volt) {
  const img = document.getElementById('chart');
  const canvas = document.getElementById('overlay');
  canvas.width  = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const x = X0 + (soc / 100) * (X1 - X0);
  const y = Y0 + (VTOP - volt) / (VTOP - VBOT) * (Y1 - Y0);
  ctx.fillStyle = 'red';
  ctx.beginPath();
  ctx.arc(x, y, 6, 0, 2 * Math.PI);
  ctx.fill();
  ctx.strokeStyle = 'white';
  ctx.lineWidth = 2;
  ctx.stroke();
}
document.getElementById('calc').onclick = () => {
  const v = parseFloat(document.getElementById('volt').value);
  const soc = invertSoC(v);
  document.getElementById('out').textContent = soc.toFixed(2);
  plotPoint(soc, v);
};
window.onload = () => {
  const v0 = parseFloat(document.getElementById('volt').value);
  const s0 = invertSoC(v0);
  document.getElementById('out').textContent = s0.toFixed(2);
  plotPoint(s0, v0);
};
</script>
</body>
</html>
