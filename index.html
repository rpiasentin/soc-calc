<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OCV → SoC Calculator with Overlay</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    /* Ensure the canvas aligns exactly over the image */
    #container { position: relative; display: block; }
    #chart     { display: block; width: 100%; height: auto; }
    #overlay   { position: absolute; top: 0; left: 0; pointer-events: none; }
    #controls  { padding: 1em; }
    input      { width: 80px; }
    button     { margin-left: 8px; }
  </style>
</head>
<body>

  <!-- 1) Chart image + overlay canvas -->
  <div id="container">
    <img id="chart" src="chart.png" alt="OCV vs SoC Curve">
    <canvas id="overlay"></canvas>
  </div>

  <!-- 2) Controls -->
  <div id="controls">
    <h1>OCV → SoC Calculator</h1>
    <label>
      Measured Voltage (V):
      <input id="volt" type="number" step="0.001" value="2.02" disabled>
    </label>
    <button id="calc" disabled>Calculate &amp; Plot</button>
    <p>Estimated SoC: <strong><span id="out">--</span>%</strong></p>
  </div>

  <script>
    // --- Embedded calibration data (201 points from your CSV) ---
    const soc_base = [0.0,0.5,1.0,1.5,2.0,2.5,3.0,3.5,4.0,4.5,5.0,5.5,6.0,6.5,7.0,7.5,8.0,8.5,9.0,9.5,10.0,10.5,11.0,11.5,12.0,12.5,13.0,13.5,14.0,14.5,15.0,15.5,16.0,16.5,17.0,17.5,18.0,18.5,19.0,19.5,20.0,20.5,21.0,21.5,22.0,22.5,23.0,23.5,24.0,24.5,25.0,25.5,26.0,26.5,27.0,27.5,28.0,28.5,29.0,29.5,30.0,30.5,31.0,31.5,32.0,32.5,33.0,33.5,34.0,34.5,35.0,35.5,36.0,36.5,37.0,37.5,38.0,38.5,39.0,39.5,40.0,40.5,41.0,41.5,42.0,42.5,43.0,43.5,44.0,44.5,45.0,45.5,46.0,46.5,47.0,47.5,48.0,48.5,49.0,49.5,50.0,50.5,51.0,51.5,52.0,52.5,53.0,53.5,54.0,54.5,55.0,55.5,56.0,56.5,57.0,57.5,58.0,58.5,59.0,59.5,60.0,60.5,61.0,61.5,62.0,62.5,63.0,63.5,64.0,64.5,65.0,65.5,66.0,66.5,67.0,67.5,68.0,68.5,69.0,69.5,70.0,70.5,71.0,71.5,72.0,72.5,73.0,73.5,74.0,74.5,75.0,75.5,76.0,76.5,77.0,77.5,78.0,78.5,79.0,79.5,80.0,80.5,81.0,81.5,82.0,82.5,83.0,83.5,84.0,84.5,85.0,85.5,86.0,86.5,87.0,87.5,88.0,88.5,89.0,89.5,90.0,90.5,91.0,91.5,92.0,92.5,93.0,93.5,94.0,94.5,95.0,95.5,96.0,96.5,97.0,97.5,98.0,98.5,99.0,99.5,100.0];

    const v_base = [1.937599053950,1.940221732050,1.943178002150,1.946149561650,1.948770231100,1.951473346250,1.954097157350,1.956437906150,1.959019484000,1.961611501700,1.964023579300,1.966527632900,1.968913998800,1.971413004600,1.973753298300,1.976241430650,1.978601202850,1.981200527250,1.983745280000,1.986160554900,1.988521634500,1.990830894200,1.993004729450,1.995110491400,1.997101475300,1.999098798150,2.001004812100,2.002951471300,2.004785245700,2.006542867000,2.008269231150,2.010010021200,2.011654048150,2.013338308650,2.015043922250,2.016643683850,2.018357449150,2.019950307900,2.021512795800,2.023014429600,2.024508634200,2.025915915900,2.027237104600,2.028645896700,2.030041492650,2.031394541150,2.032842116300,2.034255970400,2.035683842650,2.037063884200,2.038420906600,2.039960127300,2.041338836300,2.042872655800,2.044466776500,2.045905502200,2.047465704250,2.049061494200,2.050493670900,2.052019194000,2.053502487350,2.054927140000,2.056410104100,2.057918598100,2.059462733000,2.060919155500,2.062358445650,2.063702374700,2.065135042250,2.066567124250,2.067919695120,2.069253102850,2.070665686700,2.071865750450,2.073142740800,2.074349210550,2.075528874400,2.076695255250,2.077874647650,2.078894867500,2.079746418550,2.080552345150,2.081315336900,2.082096510350,2.082773806500,2.083478513250,2.083962636650,2.084427679000,2.084751701700,2.085085180250,2.085331590000,2.085591602000,2.085764539100,2.085777593450,2.085776854150,2.085619808950,2.085513204500,2.085279395350,2.084963041200,2.084567650650,2.084172638650,2.083619271900,2.083089953250,2.082552337000,2.082003687900,2.081507231800,2.081059251350,2.080493829350,2.079961726500,2.079115436700,2.078159575450,2.077089129450,2.076068805600,2.074981926750,2.073846792500,2.072776399300,2.071650307400,2.070461751200,2.069283983000,2.068168139100,2.066856429600,2.065329594800,2.063734991200,2.062060964100,2.060172569200,2.058306694900,2.056168653300,2.053885682350,2.051494727800,2.048898319000,2.046179409450,2.043327970900,2.040444327700,2.037426532000,2.034444356450,2.031292637750,2.028047581550,2.024789486150,2.020949281000,2.017138291250,2.012962633700,2.008778056350,2.003495796250,1.998168745200,1.991272282900,1.983745280000,1.975226916850,1.964968519300,1.953201672900,1.939666284150,1.924305326050,1.907293466750,1.887815084350,1.865797754900,1.840528263150,1.811823484900,1.779027585450,1.742627368250,1.702463284600,1.658581236650,1.610981131750,1.559709961600,1.504703700000,1.445935217800,1.383488268300,1.317416399300,1.247515713750,1.173151857000,1.094024190050,1.010831129000,0.923394683150,0.831513122450,0.735010440650,0.633713484100,0.527272691350,0.415892286200,0.298470760750,0.173456461000,0.039999999500,0.000000000000];

    // Build 0.01% lookup
    const s_full = Array.from({ length: 10001 }, (_, i) => i * 0.01);
    const v_full = s_full.map(sf => {
      let lo = 0, hi = soc_base.length - 1;
      while (hi - lo > 1) {
        const mid = (lo + hi) >> 1;
        if (soc_base[mid] > sf) hi = mid;
        else lo = mid;
      }
      const [s0, s1] = [soc_base[lo], soc_base[hi]];
      const [v0, v1] = [v_base[lo],   v_base[hi]];
      const t = (sf - s0) / (s1 - s0);
      return v0 + (v1 - v0) * t;
    });

    function invertSoC(v) {
      if (v <= v_full[0]) return 0.00;
      if (v >= v_full[v_full.length - 1]) return 100.00;
      let lo = 0, hi = v_full.length - 1;
      while (hi - lo > 1) {
        const mid = (lo + hi) >> 1;
        if (v_full[mid] > v) hi = mid;
        else lo = mid;
      }
      const [v0, v1] = [v_full[lo], v_full[hi]];
      const [s0, s1] = [s_full[lo], s_full[hi]];
      return s0 + (v - v0) * (s1 - s0) / (v1 - v0);
    }

    // Pixel mapping constants
    const X0 = 94,  X1 = 865,
          Y0 = 137, Y1 = 595,
          VTOP = 2.17, VBOT = 1.82;

    const img    = document.getElementById('chart'),
          canvas = document.getElementById('overlay'),
          ctx    = canvas.getContext('2d');

    function resizeCanvas() {
      const w = img.clientWidth, h = img.clientHeight;
      canvas.style.width  = w + 'px';
      canvas.style.height = h + 'px';
      canvas.width  = w;
      canvas.height = h;
    }

    function plotPoint(soc, v) {
      resizeCanvas();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const x_nat = X0 + (soc / 100) * (X1 - X0);
      const y_nat = Y0 + (VTOP - v) / (VTOP - VBOT) * (Y1 - Y0);
      const sx = canvas.width  / img.naturalWidth;
      const sy = canvas.height / img.naturalHeight;
      ctx.beginPath();
      ctx.arc(x_nat * sx, y_nat * sy, 6, 0, 2 * Math.PI);
      ctx.fillStyle = 'red';
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'white';
      ctx.stroke();
    }

    img.onload = () => {
      document.getElementById('volt').disabled = false;
      document.getElementById('calc').disabled = false;
      const v0 = parseFloat(document.getElementById('volt').value);
      const s0 = invertSoC(v0);
      document.getElementById('out').textContent = s0.toFixed(2);
      plotPoint(s0, v0);
    };
    if (img.complete) img.onload();

    document.getElementById('calc').onclick = () => {
      const v = parseFloat(document.getElementById('volt').value);
      const s = invertSoC(v);
      document.getElementById('out').textContent = s.toFixed(2);
      plotPoint(s, v);
    };
  </script>
</body>
</html>
