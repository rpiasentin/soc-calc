<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OCV → SoC Calculator with Overlay</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; }
    #container { position: relative; display: inline-block; }
    #chart { display: block; }
    #overlay { position: absolute; left: 0; top: 0; pointer-events: none; }
    label, button { font-size: 1rem; }
    input { width: 80px; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>OCV → SoC Calculator</h1>
  <div id="container">
    <!-- Render your chart image here -->
    <img id="chart" src="chart.png" alt="OCV vs SoC Curve">
    <canvas id="overlay"></canvas>
  </div>
  <p>
    <label for="volt">Measured Voltage (V):</label>
    <input id="volt" type="number" step="0.001" value="2.02">
    <button id="calc">Calculate &amp; Plot</button>
  </p>
  <p>
    Estimated SoC: <strong><span id="out">--</span>%</strong>
  </p>

  <script>
    // Calibration data embedded from your CSV
    const soc_base    = [0.00,0.50,1.00,1.50,2.00,2.50,3.00,3.50,4.00,4.50,5.00,5.50,6.00,6.50,7.00,7.50,8.00,8.50,9.00,9.50,10.00, /* … */, 99.50];
    const v_norm_base = [0.343491,0.351937,0.360427,0.367915,0.375247,0.382725,0.389021,0.395274,0.401516,0.407896,0.413947,0.420000,0.425000,0.430000,0.435000,0.440000,0.445000,0.450000,0.455000,0.460000,0.465000, /* … */, 0.993754];

    const V_MIN = 1.82, V_MAX = 2.17;

    // Precompute base voltage array
    const v_base = v_norm_base.map(vn => V_MIN + vn*(V_MAX - V_MIN));

    // Build densified lookup at 0.01% resolution
    const s_full = Array.from({length:10001},(_,i)=>i*0.01);
    const v_full = s_full.map(sf=>{
      // find bracketing in soc_base (which is every 0.5% in this example)
      let lo=0, hi=soc_base.length-1;
      while(hi-lo>1){
        const mid=(lo+hi)>>1;
        if(soc_base[mid]>sf) hi=mid;
        else lo=mid;
      }
      const s0=soc_base[lo], s1=soc_base[hi];
      const v0=v_base[lo],   v1=v_base[hi];
      const t=(sf-s0)/(s1-s0);
      return v0 + t*(v1-v0);
    });

    // Invert measured voltage -> SoC
    function invertSoC(v_meas){
      if(v_meas<=v_full[0])       return 0.00;
      if(v_meas>=v_full[v_full.length-1]) return 100.00;
      let lo=0, hi=v_full.length-1;
      while(hi-lo>1){
        const mid=(lo+hi)>>1;
        if(v_full[mid]>v_meas) hi=mid;
        else lo=mid;
      }
      const v0=v_full[lo], v1=v_full[hi];
      const s0=s_full[lo], s1=s_full[hi];
      return s0 + (v_meas-v0)/(v1-v0)*(s1-s0);
    }

    // Pixel mapping for overlay
    const X0=94, X1=865, Y0=137, Y1=595;  // your provided bounds
    const VTOP=2.17, VBOT=1.82;

    function plotPoint(soc, volt){
      const img = document.getElementById('chart');
      const canvas = document.getElementById('overlay');
      canvas.width  = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // Compute pixel coords
      const x = X0 + (soc/100)*(X1-X0);
      const y = Y0 + (VTOP-volt)/(VTOP-VBOT)*(Y1-Y0);
      // Draw marker
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, 2*Math.PI);
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    document.getElementById('calc').addEventListener('click', ()=>{
      const v = parseFloat(document.getElementById('volt').value);
      const soc = invertSoC(v);
      document.getElementById('out').textContent = soc.toFixed(2);
      plotPoint(soc, v);
    });

    // On load, draw initial point
    window.onload = () => {
      const initV = parseFloat(document.getElementById('volt').value);
      const initS = invertSoC(initV);
      plotPoint(initS, initV);
      document.getElementById('out').textContent = initS.toFixed(2);
    };
  </script>
</body>
</html>
